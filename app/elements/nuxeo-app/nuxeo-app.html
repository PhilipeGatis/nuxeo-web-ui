<!--
(C) Copyright 2016 Nuxeo SA (http://nuxeo.com/) and others.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
  Andre Justo <ajusto@nuxeo.com>
  Nelson Silva <nsilva@nuxeo.com>
  Gabriel Barata <gbarata@nuxeo.com>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-routing-behavior.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-i18n-behavior.html">
<link rel="import" href="../nuxeo-filters-behaviour/nuxeo-filters-behaviour.html">

<!--
`nuxeo-app`
@group Nuxeo UI
@element nuxeo-app
-->
<dom-module id="nuxeo-app">
  <template>
    <style is="custom-style" include="shared-styles">
      .logo {
        background: rgba(255,255,255,0.9);
        border-right: var(--nuxeo-border);
        height: 59px;
        padding: 18px;
        position: fixed;
        top: 0;
        left: 0;
        width: 60px;
        z-index: 102;
      }

      paper-badge {
        --paper-badge-background: var(--nuxeo-badge-background);
      }

      iron-collapse {
        overflow: scroll;
      }

      #sidebar > div {
        margin-left: 60px;
      }

      #sidebar section {
        border-right: var(--nuxeo-border);
      }

      #sidebar .content {
        font-size: .9rem;
        @apply(--layout-flex);
        @apply(--layout-vertical);
        overflow: auto;
        width: 290px;
        height: calc(100vh - 59px);
      }

      #sidebar .card .header {
        height: 59px;
        background-color: var(--nuxeo-light-background);
        border-bottom: var(--nuxeo-border);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      #sidebar .card h1 {
        color: var(--nuxeo-tag-text);
        text-transform: uppercase;
        font-size: 1rem;
        margin: .1em .2em 0 1.1em;
        font-weight: 500;
      }

      #sidebar .item {
        border-bottom: var(--nuxeo-border);
        display: block;
      }

      #sidebar .item a {
        margin-bottom: 0;
        padding: 1em;
        display: block;
      }

      #sidebar .tasks .link {
        font-size: 1.2em;
        padding: 1em 1em 2em 1em;
        text-align: center;
      }

      #sidebar .profile .item:last-of-type {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        border: none;
        justify-content: flex-end;
      }

      .icon-badge {
        position: relative;
      }

      .header-badge {
        left: 33px !important;
        top: 6px !important;
        position: absolute;
      }

      [hidden] {
        display: none !important;
      }

      nuxeo-task-widget {
        --nuxeo-task-widget-box-padding: 1em 1em 1em .7em;
        font-size: .9em;
      }

      nuxeo-tasks-list {
        font-size: .9em;
      }

      .side-nav {
        padding: 60px 0;
        overflow: auto;
        background-color: var(--nuxeo-sidebar-background);
      }

      .side-nav paper-icon-button {
        color: var(--nuxeo-sidebar-actions);
        height: 50px;
        padding: 14px;
        width: 60px;
      }

      .side-nav .iron-selected,
      .side-nav paper-icon-button:hover,
      .side-nav paper-icon-button[focused] {
        color: #fff;
        fill: #fff;
        background-color: rgba(0,0,0,.15);
      }

      .side-nav paper-icon-button:focus ::content iron-icon {
        fill: #fff; }

      paper-menu {
        --paper-menu-focused-item-after: {
          background-color: rgba(0,0,0,.15);
          color: #fff;
        };
      }

      .side-nav .profile-icon {
        bottom: 0;
        position: fixed;
        left: 0;
        height: 59px;
      }

      paper-card {
        margin: 0 22px 22px 0;
        min-width: 560px;
        width: 100%;
        height: 100%;
      }

      paper-card .title {
        color: var(--nuxeo-header-title-color);
        font-size: 1.4rem;
        margin: 0 0 .4em;
        padding-bottom: 8px;
        border-bottom: var(--nuxeo-border);
      }

      nuxeo-document-create-button.admin {
        display: none;
      }

      .experimental {
        position: absolute;
        color: var(--nuxeo-button-primary);
        right: 5px;
        bottom: 5px;
        font-size: .7em;
      }
    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>

    <nuxeo-document id="doc" doc-id="[[docId]]" doc-path="[[docPath]]"
                    enrichers="permissions, breadcrumb, preview, favorites, renditions, pendingTasks, runnableWorkflows, runningWorkflows, collections, audit"
                    headers='{"X-NXfetch.document": "lock"}'>
    </nuxeo-document>

    <nuxeo-resource id="tasks" path="/task"
                    headers='{"X-NXfetch.task": "targetDocumentIds,actors"}'>
    </nuxeo-resource>

    <nuxeo-document auto
                    doc-id="[[selectedSearch.id]]"
                    enrichers="permissions"
                    response="{{searchDoc}}">
    </nuxeo-document>

    <nuxeo-document auto
                    doc-id="[[selectedAssetsSearch.id]]"
                    enrichers="permissions"
                    response="{{assetsSearchDoc}}">
    </nuxeo-document>

    <paper-toast id="toast"></paper-toast>

    <paper-drawer-panel drawer-width="[[drawerWidth]]" responsive-width="720px">
      <div drawer>
        <a href$="[[urlFor('home')]]">
          <paper-icon-button src$="[[baseUrl]]images/touch/icon-128x128.png" class="logo"></paper-icon-button>
        </a>
        <paper-menu class="side-nav" selected="{{selectedTab}}" attr-for-selected="name" on-iron-activate="_toggleDrawer">
          <paper-icon-button noink id="menuHome" class="menu-icon" icon="icons:folder-open" name="browser"></paper-icon-button>
          <paper-icon-button noink id="menuRecents" icon="icons:restore" name="recents"></paper-icon-button>
          <paper-icon-button noink id="menuSearch" icon="icons:search" name="search"></paper-icon-button>
          <paper-icon-button noink id="menuAssets" icon="icons:perm-media" name="assets"></paper-icon-button>
          <div id="menuTasks" class="icon-badge" name="tasks">
            <paper-icon-button noink icon="icons:check-box" name="tasks" id="tasksCounter"></paper-icon-button>
            <paper-badge label="[[taskCount]]" class="header-badge" for="tasksCounter"></paper-badge>
          </div>
          <paper-icon-button noink id="menuFavorites" icon="icons:star" name="favorites"></paper-icon-button>
          <paper-icon-button noink id="menuCollections" icon="icons:book" name="collections"></paper-icon-button>
          <paper-icon-button noink id="menuPersonal" icon="icons:folder-shared" name="personalWorkspace"></paper-icon-button>
          <paper-icon-button noink id="menuClipboard" icon="icons:content-paste" name="clipboard"></paper-icon-button>
          <paper-icon-button noink id="menuAdministration" icon="icons:build" name="administration" hidden$="[[!currentUser.isAdministrator]]"></paper-icon-button>
          <paper-icon-button noink id="menuAccount" icon="icons:account-circle" name="profile" class="profile-icon"></paper-icon-button>
        </paper-menu>

        <iron-collapse id="sidebar" horizontal opened>
          <div>
            <iron-pages selected="[[selectedTab]]" attr-for-selected="name" class="flex">
              <section class="card browse" name="browser">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.browse', 'Browse')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-document-tree root-path="/default-domain" current-document="[[currentDocument]]"></nuxeo-document-tree>
                </div>
              </section>

              <section class="card recents" name="recents">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.recentlyViewed', 'Recently Viewed')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-recent-documents max-size="10" id="recent"></nuxeo-recent-documents>
                </div>
              </section>

              <section class="card search" name="search">
                <nuxeo-search-form id="searchForm" search-name="faceted" on-display-filters="_resetSearchResults" dirty="{{dirty}}"
                                   is-saved-search="{{searchLoaded}}" selected-search="{{selectedSearch}}">
                </nuxeo-search-form>
              </section>

              <section class="card" name="assets">
                <nuxeo-search-form id="assetsForm" search-name="assets" provider="assets_search" on-display-filters="_resetAssetsResults"
                                   dirty="{{assetsDirty}}" is-saved-search="{{assetsSearchLoaded}}" selected-search="{{selectedAssetsSearch}}">
                </nuxeo-search-form>
              </section>

              <section class="card tasks" name="tasks">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.tasks', 'Tasks')]]</h1>
                </div>
                <div class="content layout vertical">
                  <nuxeo-tasks-list id="tasks-list" tasks="[[tasks]]" current="[[currentTask]]" class="flex"></nuxeo-tasks-list>
                  <div class="link">
                    <a href$="[[urlFor('tasks')]]">[[i18n('command.app.viewTaskDashboard', '» View Tasks Dashboard')]]</a>
                  </div>
                </div>
              </section>

              <section class="card favorites" name="favorites">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.favorites', 'Favorites')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-favorites doc="[[currentDocument]]"></nuxeo-favorites>
                </div>
              </section>

              <section class="card collections" name="collections">
                <nuxeo-collections id="collectionsForm"></nuxeo-collections>
              </section>

              <section class="card personal-space" name="personalWorkspace">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.personalSpace', 'Personal Space')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-document-tree id="userWorkspace" root-path="[[_userWorkspacePath]]" current-document="[[currentDocument]]">
                  </nuxeo-document-tree>
                </div>
              </section>

              <section class="card clipboard" name="clipboard">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.clipboard', 'Clipboard')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-clipboard id="clipboard" target-document="[[currentDocument]]"></nuxeo-clipboard>
                </div>
              </section>

              <template is="dom-if" if="[[currentUser.isAdministrator]]">
                <section class="card administration" name="administration">
                  <div class="header ellipsis">
                    <h1>[[i18n('heading.app.administration', 'Administration')]]</h1>
                  </div>
                  <div class="content">
                    <iron-selector selected="{{selectedAdminTab}}" attr-for-selected="name">
                      <div class="item" name="analytics">
                        <a href$="[[urlFor('administration', 'analytics')]]">Analytics</a>
                      </div>
                      <div class="item" name="user-group-management">
                        <a href$="[[urlFor('administration', 'user-group-management')]]">[[i18n('label.app.usersAndGroups', 'Users & Groups')]]</a>
                      </div>
                      <div class="item" name="vocabulary-management">
                        <a href$="[[urlFor('administration', 'vocabulary-management')]]">[[i18n('label.app.vocabularyManagement', 'Vocabulary')]]</a>
                      </div>
                    </iron-selector>
                  </div>
                </section>
              </template>

              <section class="card profile" name="profile">
                <div class="header ellipsis">
                  <h1>[[_displayUser(currentUser)]]</h1>
                </div>
                <div class="content">
                  <div class="item">
                    <a href$="[[urlFor('drive')]]">[[i18n('ui.app.user.drive','Drive')]]</a>
                  </div>
                  <div class="item">
                    <a href$="[[urlFor('themes')]]">[[i18n('ui.app.user.themes','Themes')]]</a>
                  </div>
                  <div class="item layout vertical">
                    <a href="[[_connectionUrl()]]/logout">[[i18n('ui.app.user.signOut','Sign Out')]]</a>
                  </div>
                </div>
              </section>
            </iron-pages>
          </div>
        </iron-collapse>
      </div>

      <paper-header-panel main>
        <div class="layout horizontal">

          <iron-pages selected="[[page]]" attr-for-selected="name" class="flex">
            <nuxeo-home name="home" tasks="[[tasks]]"></nuxeo-home>

            <!-- The current document's page -->
            <nuxeo-browser id="browser"
              name="browse"
              document="[[currentDocument]]"
              selected-tab="{{docAction}}"
              clipboard="[[clipboard]]"></nuxeo-browser>

            <!-- Default Search -->
            <nuxeo-search-results id="searchResults" name="search" on-navigate="_navigateFromSearch">
              <nuxeo-saved-search-actions class="actions" search-doc="[[searchDoc]]" search-loaded="[[searchLoaded]]" dirty="[[dirty]]"></nuxeo-saved-search-actions>
            </nuxeo-search-results>

            <!-- Assets Search -->
            <nuxeo-search-results id="assetsResults" name="assets" on-navigate="_navigateFromAssetsSearch" display-mode="grid">
              <nuxeo-saved-search-actions class="actions" search-doc="[[assetsSearchDoc]]" search-loaded="[[assetsSearchLoaded]]" dirty="[[assetsDirty]]"></nuxeo-saved-search-actions>
            </nuxeo-search-results>

            <nuxeo-collection-results id="collectionResults"
              name="collection" on-navigate="_navigateFromCollection">
            </nuxeo-collection-results>

            <nuxeo-admin name="admin" selected-tab="[[selectedAdminTab]]" entity="[[entity]]"></nuxeo-admin>

            <div name="tasks">
              <nuxeo-tasks id="tasks-dashboard" tasks="[[tasks]]" current="[[currentTask]]"></nuxeo-tasks>
            </div>

            <!-- Nuxeo Drive page -->
            <paper-header-panel class="flex" name="drive">
              <div class="paper-header layout horizontal">
                <span class="flex">[[i18n('ui.app.drive.heading','Nuxeo Drive')]]</span>
              </div>
              <div class="content">
                <paper-card class="card" elevation="0">
                  <div class="card-content">
                    <div class="title">[[i18n('ui.app.drive.packages','Packages')]]</div>
                    <nuxeo-drive-desktop-packages></nuxeo-drive-desktop-packages>
                  </div>
                </paper-card>
                <paper-card class="card" elevation="0">
                  <div class="card-content">
                    <div class="title">[[i18n('ui.app.drive.roots','Synchronization Roots')]]</div>
                    <nuxeo-drive-sync-roots-management></nuxeo-drive-sync-roots-management>
                  </div>
                </paper-card>
                <paper-card class="card" elevation="0">
                  <div class="card-content">
                    <div class="title">[[i18n('ui.app.drive.tokens','Tokens')]]</div>
                    <nuxeo-authentication-tokens-management application="Nuxeo Drive"></nuxeo-authentication-tokens-management>
                  </div>
                </paper-card>
              </div>
            </paper-header-panel>

            <!-- Themes -->
            <paper-header-panel class="flex" name="themes">
              <div class="paper-header layout horizontal">
                <span class="flex">[[i18n('ui.app.themes.heading','Themes')]]</span>
              </div>
              <div class="content">
                <nuxeo-themes></nuxeo-themes>
              </div>
            </paper-header-panel>
          </iron-pages>
        </div>
        <nuxeo-suggester id="suggester"></nuxeo-suggester>
      </paper-header-panel>
    </paper-drawer-panel>

    <paper-tooltip for="menuHome" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.browse', 'Browse')]]</paper-tooltip>
    <paper-tooltip for="menuRecents" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.recentlyViewed', 'Recently Viewed')]]</paper-tooltip>
    <paper-tooltip for="menuSearch" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.search', 'Search Filters')]]</paper-tooltip>
    <paper-tooltip for="menuAssets" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.assets', 'Assets Search')]]</paper-tooltip>
    <paper-tooltip for="menuTasks" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.tasks', 'Tasks')]]</paper-tooltip>
    <paper-tooltip for="menuFavorites" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.favorites', 'Favorites')]]</paper-tooltip>
    <paper-tooltip for="menuCollections" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.collections', 'Collections')]]</paper-tooltip>
    <paper-tooltip for="menuPersonal" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.personalSpace', 'Personal Space')]]</paper-tooltip>
    <paper-tooltip for="menuClipboard" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.clipboard', 'Clipboard')]]</paper-tooltip>
    <paper-tooltip for="menuAdministration" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.administration', 'Administration')]]</paper-tooltip>
    <paper-tooltip for="menuAccount" position="right" offset="0" animation-delay="0">
      [[i18n('heading.app.account', 'User Settings')]]</paper-tooltip>

    <nuxeo-document-create-button class$="[[page]]" parent="[[currentParent]]"></nuxeo-document-create-button>
    <nuxeo-document-create-popup id="importPopup" parent="[[currentParent]]"></nuxeo-document-create-popup>

    <iron-a11y-keys
      id="keys"
      keys="ctrl+space"
      target="[[keyPressTarget]]"
      on-keys-pressed="_handleKeyPresses">
    </iron-a11y-keys>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-app',
        behaviors: [Nuxeo.RoutingBehavior, Nuxeo.I18nBehavior, Nuxeo.FiltersBehavior],
        properties: {
          baseUrl: {
            type: String,
            value: '/'
          },
          page: {
            type: String,
            observer: '_navigate'
          },

          selectedTab: {
            type: String,
            observer: '_observeSelectedTab'
          },

          selectedAdminTab: String,

          currentDocument: Object,
          currentParent: Object,
          docId: String,
          docPath: String,
          docAction: String,

          entity: Object,

          tasks: Array,

          taskCount: Number,

          drawerWidth: {
            type: String,
            value: '60px'
          },

          drawerOpened: {
            type: Boolean,
            value: false
          },

          keyPressTarget: {
            type: Object,
            value: function() {
              return document.body;
            }
          },

          currentTask: {
            type: Object
          },

          currentUser: {
            type: Object,
            observer: '_observeCurrentUser'
          },

          _userWorkspacePath: {
            type: String
          }

        },

        listeners: {
          'document-updated': 'refresh',
          'create-document': 'showDocumentCreationWizard',
          'document-created': '_handleDocumentCreated',
          'nuxeo-content-view-navigate': '_navigateFromCV',
          'goHome': '_handleUGMgoHome',
          'manageUser': '_handleUGMmanageUser',
          'manageGroup': '_handleUGMmanageGroup',
          'browseCollection': '_navigateToCollection',
          'workflowStarted': '_refreshAndFetchTasks',
          'workflowTaskProcessed': '_refreshAndFetchTasks',
          'taskChanged': '_onTaskChanged',
          'tasksListSelectionChanged': '_onTasksListSelectionChanged',
          'addToClipboard': '_onAddToClipboard',
          'addedToCollection': '_documentAddedToCollection',
          'removedFromCollection': '_documentRemovedFromCollection'
        },

        ready: function() {
          this.clipboard = this.$.clipboard;
          this.$.searchResults.nxProvider = this.$.searchForm.nxProvider;
          this.$.assetsResults.nxProvider = this.$.assetsForm.nxProvider;
          // XXX: review this
          this.$.searchResults.querySelector('nuxeo-saved-search-actions').searchForm = this.$.searchForm;
          this.$.assetsResults.querySelector('nuxeo-saved-search-actions').searchForm = this.$.assetsForm;
          // XXX: end of review this
          this.$.collectionResults.nxProvider = this.$.collectionsForm.nxProvider;
          if (this.shadowRoot) {
            var experimental = document.createElement('div');
            experimental.innerHTML = 'shadow dom enabled';
            experimental.className = 'experimental';
            Polymer.dom(this.root).appendChild(experimental);
          }
          this.$.nxcon.connect().then(function(res) {
            this.currentUser =  res;
          }.bind(this));
        },

        updateDoc: function(id, path, action) {
          this.docId = id;
          this.docPath = path;
          this.docAction = action;
          this.$.doc.get().then(function(doc) {
            if (this.docId && !this._isVersion(doc)) {
              this.docId = '';
              this.docPath = doc.path;
              this._navigate();
            } else {
              this.$.recent.add(doc);
              this.currentParent = this._isFolderish(doc) ? doc :
                doc.contextParameters.breadcrumb.entries.slice(-2,-1)[0];
              this.set('currentDocument', doc);
            }
          }.bind(this));
        },

        refresh: function() {
          this.updateDoc(this.docId, this.docPath, this.docAction);
        },

        showDocumentCreationWizard: function(e) {
          this.$.importPopup.toggleDialog(e.detail ? e.detail.files : null);
        },

        _navigate: function() {
          var url = '/' + this.page, state;
          if (this.page === 'browse') {
            if (this.docId) {
              return;
            }
            if (this.docPath) {
              url += this.docPath;
            }
            if (this.docAction) {
              url += '@' + this.docAction;
            }
            if (this.currentContentView) {
              state = {contentView: this.currentContentView.provider};
            }
          } else if (this.page === 'admin') {
            if (this.selectedAdminTab) {
              url += '/' + this.selectedAdminTab;
              if (this.selectedAdminTab === 'user-group-management' &&
                  this.entity && this.entity.id && this.entity.type) {
                url += '/' + this.entity.type + '/' + this.entity.id;
              }
            }
          }
          page.show(url, state);
          this.fire('navigation', {page: this.page});
        },

        _navigateFromCV: function(e) {
          this.currentContentView = Polymer.dom(e).rootTarget;
          page.show('/browse' + this.currentContentView.currentDocument.path,
                    {contentView: this.currentContentView.provider});
        },

        _navigateFromSearch: function(e) {
          page.show('/browse' + e.detail.doc.path);
          this.$.searchForm.displayQueue(e.detail.doc, e.detail.index);
        },

        _navigateFromAssetsSearch: function(e) {
          page.show('/browse' + e.detail.doc.path);
          this.$.assetsForm.displayQueue(e.detail.doc, e.detail.index);
        },

        _navigateFromCollection: function(e) {
          page.show('/browse' + e.detail.doc.path);
          this.$.collectionsForm.displayMembers(e.detail.doc, e.detail.index);
        },

        _resetSearchResults: function() {
          this.selectedTab = this.page = 'search';
        },

        _resetAssetsResults: function() {
          this.selectedTab = this.page = 'assets';
        },

        _navigateToCollection: function(e) {
          this.selectedTab = 'collections';
          this.page = 'collection';
          this.$.collectionResults.collection = e.detail.collection;
        },

        get currentContentView() {
          return this.$.browser.currentContentView;
        },

        set currentContentView(cv) {
          this.$.browser.currentContentView = cv;
        },

        scrollPageToTop: function() {
          //this.$.selectedPage.scrollToTop(true);
        },

        _toggleDrawer: function(e) {
          if (this._selected === e.detail.selected && this.drawerOpened) {
            this.drawerWidth = '60px';
            this.drawerOpened = false;
          } else {
            this.drawerWidth = '350px';
            this.$.sidebar.style.width = '100%';
            this.drawerOpened = true;
          }
          this._selected = e.detail.selected;
        },

        _handleKeyPresses: function() {
          this.$.suggester.toggle();
        },

        _handleUGMgoHome: function() {
          this.entity = {};
          this._navigate();
        },

        _handleUGMmanageUser: function(e) {
          this.entity = {type: 'user', id: e.detail.user};
          this._navigate();
        },

        _handleUGMmanageGroup: function(e) {
          this.entity = {type: 'group', id: e.detail.group};
          this._navigate();
        },

        _observeSelectedTab: function() {
          if (this.selectedTab === 'search' || this.selectedTab === 'assets') {
            this.page = this.selectedTab;
          } else if (this.selectedTab === 'personalWorkspace') {
            var tree = this.$.userWorkspace.$.tree;
            tree.open.apply(tree, [this.$.userWorkspace.rootDocument.uid]);
          }
        },

        _fetchTasks: function() {
          // hack to fetch tasks with user prefix and without prefix
          // some tasks are prefixed, to be reviewed later
          this._tmpTasks = [];
          this.$.tasks.params = {'userId': this.currentUser.id};
          this.$.tasks.get().then(function(response) {
            this._tmpTasks = response.entries;
            this.$.tasks.params = {'userId': 'user:' + this.currentUser.id};
            this.$.tasks.get().then(function(response) {
              this.tasks = this._tmpTasks.concat(response.entries);
              this.taskCount = this.tasks.length;
            }.bind(this));
          }.bind(this));
        },

        _refreshAndFetchTasks: function() {
          // let's refresh the current document since it might have been changed (ex: state and version)
          this.refresh();
          this._fetchTasks();
        },

        _onTaskChanged: function(e) {
          this.currentTask = e.detail.task;
        },

        _onTasksListSelectionChanged: function() {
          this.page = 'tasks';
        },

        _onAddToClipboard: function(e) {
          if (e.detail.documents) {
            e.detail.documents.forEach(function(doc) {
              if (!this.clipboard.contains(doc)) {
                this.clipboard.add(doc);
              }
            }.bind(this));
          }
        },

        _observeCurrentUser: function() {
          if (this.currentUser) {
            this._userWorkspacePath =  '/default-domain/UserWorkspaces/' + this.currentUser.id;
            this._fetchTasks();
          }
        },

        _displayUser: function(user) {
          if (user) {
            var result = '';
            if (user.properties['firstName']) {
              result += user.properties['firstName'];
            }
            if (user.properties['lastName']) {
              if (result.length > 0) {
                result += ' ';
              }
              result += user.properties['lastName'];
            }
            if (result.length === 0) {
              result = user.id;
            }
            return result;
          }
        },

        _connectionUrl: function() {
          return this.$.nxcon.url;
        },

        _documentAddedToCollection: function(e) {
          if (e.detail.docIds) {
            this.$.toast.text = this.i18n('documents_added_to_collection', 'Documents added to collection.');
          } else {
            this.$.toast.text = this.i18n('document_added_to_collection', 'Document added to collection.');
          }
          this.$.toast.open();
        },

        _documentRemovedFromCollection: function() {
          this.$.toast.text = this.i18n('document_removed_from_collection', 'Document removed from collection.');
          this.$.toast.open();
        },

        _handleDocumentCreated: function(e) {
          if (!e.detail.response.entries || e.detail.response.entries.length === 1) {
            var doc = e.detail.response.entries ? e.detail.response.entries[0] : e.detail.response;
            this.$.toast.text = this.i18n('label.documents.createdDocument', 'Created {0}.',
                        doc.type.toLowerCase() + ' ' + doc.title);
          } else {
            this.$.toast.text = this.i18n('label.documents.createdDocuments', 'Created {0} documents.',
                        e.detail.response.entries.length);
          }
          this.$.toast.open();
        }

      });
    })();
  </script>

</dom-module>
